---
import useLang from "@utils/useLang";
import ButtonIcon from "@components/buttons/ButtonIcon.astro";
import sources from "@consts/sources";
import Github from "@assets/icons/github.svg";
import Linkedin from "@assets/icons/linkedin.svg";
import Email from "@assets/icons/email.svg";
import Button from "@components/buttons/Button.astro";
const { t } = useLang(Astro.url);
const recaptchaSiteKey = import.meta.env.ASTRO_PUBLIC_RECAPTCHA_SITE_KEY;
const recaptchaEnabled = Boolean(recaptchaSiteKey);
const recaptchaAction = "contact_submit";
---

<section id="contact" class="w-full h-vh p-0 sm:p-10">
  <div
    class="sm:max-w-7xl mx-auto px-6 sm:px-10 xl:px-0 py-10 grid grid-cols-1 gap-10"
  >
    <div class="flex flex-col gap-3">
      <h4 class="text-3xl font-bold text-center">
        {t("contact.sectionTitle")}
      </h4>
      <p class="text-center text-2 sm:w-4/4 md:w-3/4 lg:w-2/4 mx-auto">
        {t("contact.sectionDescription")}
      </p>
    </div>

    <div
      class="grid gap-7 grid-cols-1 sm:grid-cols-[1fr_1px_1fr] items-center justify-center"
    >
      <div class="w-full flex items-center justify-center">
        <div class="grid grid-cols-2 sm:grid-cols-1 gap-2 items-center">
          <h6 class="text-2xl font-bold">
            {t("contact.stayInTouchTitle")}
          </h6>
          <div class="grid grid-cols-1 gap-2">
            <p class="text-md font-semibold">{sources.name}</p>
            <p class="text-md font-semibold">{sources.email}</p>
            <p class="text-md font-semibold">{sources.phone}</p>
            <div class="flex items-center gap-3">
              <ButtonIcon variant="white" href={sources.github}>
                <Github />
              </ButtonIcon>
              <ButtonIcon variant="white" href={sources.linkedin}>
                <Linkedin />
              </ButtonIcon>
              <ButtonIcon variant="white" href={sources.email}>
                <Email />
              </ButtonIcon>
            </div>
          </div>
        </div>
      </div>
      <div class="w-[1px] h-full bg-2"></div>
      <div class="w-full sm:w-3/4 flex flex-col gap-3 p-4 mx-auto">
        <h6 class="text-2xl font-bold mb-2 sm:text-left text-center">
          {t("contact.form.title")}
        </h6>
        <form
          id="contact-form"
          action="/api/contact"
          method="post"
          novalidate
          class="grid grid-cols-1 gap-5"
          data-recaptcha-site-key={recaptchaSiteKey ?? ""}
          data-error-name={t("contact.form.errors.name")}
          data-error-email={t("contact.form.errors.email")}
          data-error-message={t("contact.form.errors.message")}
          data-status-invalid={t("contact.form.status.invalid")}
          data-status-success={t("contact.form.status.success")}
          data-status-error={t("contact.form.status.error")}
          data-status-recaptcha={t("contact.form.status.recaptcha")}
          data-recaptcha-action={recaptchaAction}
        >
          <input type="hidden" name="token" />
          <input
            type="text"
            name="company"
            tabindex="-1"
            autocomplete="off"
            aria-hidden="true"
            class="hidden"
          />
          <div class="grid gap-1">
            <input
              id="contact-name"
              class="w-full p-2 border-2 border-black rounded-lg"
              type="text"
              name="name"
              autocomplete="name"
              required
              aria-describedby="contact-name-error"
              placeholder={t("contact.form.namePlaceholder")}
            />
            <p
              id="contact-name-error"
              data-error-for="name"
              class="text-sm text-red-600"
            >
            </p>
          </div>
          <div class="grid gap-1">
            <input
              id="contact-email"
              class="w-full p-2 border-2 border-black rounded-lg"
              type="email"
              name="email"
              autocomplete="email"
              required
              aria-describedby="contact-email-error"
              placeholder={t("contact.form.emailPlaceholder")}
            />
            <p
              id="contact-email-error"
              data-error-for="email"
              class="text-sm text-red-600"
            >
            </p>
          </div>
          <div class="grid gap-1">
            <textarea
              id="contact-message"
              class="w-full p-2 border-2 border-black rounded-lg"
              name="message"
              rows="5"
              required
              aria-describedby="contact-message-error"
              placeholder={t("contact.form.messagePlaceholder")}></textarea>
            <p
              id="contact-message-error"
              data-error-for="message"
              class="text-sm text-red-600"
            >
            </p>
          </div>
          <p data-status class="text-sm" role="status" aria-live="polite"></p>
          <div class="flex items-center justify-center sm:justify-start">
            <Button
              type="submit"
              variant="black"
              size="sm"
              class=""
              disabled={!recaptchaEnabled}>{t("contact.form.submit")}</Button
            >
          </div>
        </form>
      </div>
    </div>
  </div>
</section>

{
  recaptchaEnabled && (
    <script
      src={`https://www.google.com/recaptcha/api.js?render=${recaptchaSiteKey}`}
      async
      defer
    />
  )
}

<script type="module">
  import { contactSchema } from "@utils/validation/contactSchema";

  const initContactForm = () => {
    const form = document.querySelector("#contact-form");
    if (!form) return;

    const nameInput = form.querySelector('[name="name"]');
    const emailInput = form.querySelector('[name="email"]');
    const messageInput = form.querySelector('[name="message"]');
    const botInput = form.querySelector('[name="company"]');
    const tokenInput = form.querySelector('[name="token"]');
    const submitButton = form.querySelector('button[type="submit"]');
    const status = form.querySelector("[data-status]");

    const errorElements = {
      name: form.querySelector('[data-error-for="name"]'),
      email: form.querySelector('[data-error-for="email"]'),
      message: form.querySelector('[data-error-for="message"]'),
    };

    const messages = {
      name: form.dataset.errorName ?? "Please enter a valid name.",
      email: form.dataset.errorEmail ?? "Please enter a valid email.",
      message: form.dataset.errorMessage ?? "Please enter a valid message.",
      invalid: form.dataset.statusInvalid ?? "Check the highlighted fields.",
      success: form.dataset.statusSuccess ?? "Message sent successfully.",
      error: form.dataset.statusError ?? "Something went wrong. Try again.",
      recaptcha:
        form.dataset.statusRecaptcha ??
        "reCAPTCHA verification failed. Try again.",
    };

    const recaptchaSiteKey = form.dataset.recaptchaSiteKey ?? "";
    const recaptchaAction = form.dataset.recaptchaAction ?? "contact_submit";

    const setStatus = (text, tone) => {
      if (!status) return;
      status.textContent = text;
      status.classList.remove("text-green-600", "text-red-600");
      if (tone === "success") status.classList.add("text-green-600");
      if (tone === "error") status.classList.add("text-red-600");
    };

    const setFieldError = (field, message) => {
      const errorEl = errorElements[field];
      if (errorEl) errorEl.textContent = message ?? "";
      const inputEl = {
        name: nameInput,
        email: emailInput,
        message: messageInput,
      }[field];
      if (inputEl) {
        inputEl.setAttribute("aria-invalid", message ? "true" : "false");
      }
    };

    const clearErrors = () => {
      setFieldError("name", "");
      setFieldError("email", "");
      setFieldError("message", "");
    };

    const validateForm = () => {
      if (!nameInput || !emailInput || !messageInput) return false;
      const result = contactSchema.safeParse({
        name: nameInput.value,
        email: emailInput.value,
        message: messageInput.value,
        botField: botInput?.value ?? "",
      });

      if (result.success) {
        clearErrors();
        return true;
      }

      const fieldsWithErrors = new Set(
        result.error.issues.map((issue) => issue.path[0]),
      );
      setFieldError("name", fieldsWithErrors.has("name") ? messages.name : "");
      setFieldError(
        "email",
        fieldsWithErrors.has("email") ? messages.email : "",
      );
      setFieldError(
        "message",
        fieldsWithErrors.has("message") ? messages.message : "",
      );
      return false;
    };

    form.addEventListener("input", () => {
      validateForm();
    });

    form.addEventListener("submit", async (event) => {
      event.preventDefault();

      if (!recaptchaSiteKey) {
        setStatus(messages.recaptcha, "error");
        return;
      }

      const isValid = validateForm();
      if (!isValid) {
        setStatus(messages.invalid, "error");
        return;
      }

      if (!window.grecaptcha) {
        setStatus(messages.recaptcha, "error");
        return;
      }

      submitButton?.setAttribute("disabled", "true");

      try {
        await new Promise((resolve) => window.grecaptcha.ready(resolve));
        const token = await window.grecaptcha.execute(recaptchaSiteKey, {
          action: recaptchaAction,
        });

        if (tokenInput) tokenInput.value = token;

        const payload = {
          name: nameInput?.value ?? "",
          email: emailInput?.value ?? "",
          message: messageInput?.value ?? "",
          botField: botInput?.value ?? "",
          token,
        };

        const response = await fetch(form.action, {
          method: "POST",
          body: JSON.stringify(payload),
          headers: {
            Accept: "application/json",
            "Content-Type": "application/json",
          },
        });

        if (!response.ok) {
          const data = await response.json().catch(() => null);
          if (data?.error === "recaptcha") {
            setStatus(messages.recaptcha, "error");
          } else {
            setStatus(messages.error, "error");
          }
          return;
        }

        const redirectUrl = new URL(window.location.href);
        redirectUrl.searchParams.set("contact", "success");
        redirectUrl.hash = "";
        window.location.assign(redirectUrl.toString());
      } catch (error) {
        setStatus(messages.error, "error");
    } finally {
      submitButton?.removeAttribute("disabled");
      if (tokenInput) tokenInput.value = "";
    }
    });
  };

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initContactForm, {
      once: true,
    });
  } else {
    initContactForm();
  }
</script>
