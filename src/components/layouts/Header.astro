---
import useLang from "../../utils/useLang";
import Button from "../buttons/Button.astro";

const { t, lang } = useLang(Astro.url);
const languages = [
  {
    code: "es",
    label: t("languageSelector.options.es"),
    icon: "/images/flag-es.svg",
  },
  {
    code: "en",
    label: t("languageSelector.options.en"),
    icon: "/images/flag-en.svg",
  },
];
---

<header
  class="w-full h-18 mx-auto px-6 sm:px-10 xl:px-0 flex items-center justify-between sm:max-w-7xl"
>
  <div
    class="font-bold text-xl uppercase mx-auto sm:mx-0"
    itemscope
    itemtype="https://schema.org/Person"
  >
    <span itemprop="name">{t("header.name")}</span>
  </div>
  <nav class="items-center gap-6 hidden sm:flex" aria-label="Main navigation">
    <a href="#start" class="nav-link uppercase text-sm">
      {t("header.nav.start")}
    </a>
    <a href="#about" class="nav-link uppercase text-sm">
      {t("header.nav.about")}
    </a>
    <a href="#projects" class="nav-link uppercase text-sm">
      {t("header.nav.projects")}
    </a>
    <Button href="#contact" variant="black" size="sm">
      {t("header.cta")}
    </Button>
  </nav>
  <div class="ml-4">
    <div
      class="lang-toggle"
      role="group"
      aria-label={t("languageSelector.label")}
    >
      {languages.map(({ code, label, icon }) => (
        <button
          type="button"
          class={`lang-button ${lang === code ? "is-active" : ""}`}
          data-lang-button
          value={code}
          aria-pressed={lang === code}
          aria-label={label}
          title={label}
        >
          <img src={icon} alt="" aria-hidden="true" class="lang-flag" />
          <span class="sr-only">{label}</span>
        </button>
      ))}
    </div>
  </div>
</header>
<script>
  const storageKey = "preferredLang";
  const buttons = Array.from(
    document.querySelectorAll("[data-lang-button]") ?? []
  );

  const getPathForLang = (value) => (value === "en" ? "/en/" : "/");
  const getCurrentLang = () => document.documentElement.lang || "es";

  const applyPreferredLang = () => {
    if (typeof window === "undefined" || buttons.length === 0) return;
    const saved = localStorage.getItem(storageKey);
    const current = getCurrentLang();
    if (saved && saved !== current) {
      window.location.href = getPathForLang(saved);
    }
  };

  if (typeof window !== "undefined" && buttons.length > 0) {
    applyPreferredLang();

    buttons.forEach((button) => {
      button.addEventListener("click", (event) => {
        const target = event.currentTarget;
        const value = target?.value;
        if (!target) return;
        localStorage.setItem(storageKey, value);
        if (getCurrentLang() !== value) {
          window.location.href = getPathForLang(value);
        }
      });
    });
  }
</script>
<style>
  .nav-link {
    position: relative;
    display: inline-block;
    margin-top: 0.25rem;
    transition: color 0.3s ease;
  }

  /* Línea horizontal inferior */
  .nav-link::after {
    content: "";
    position: absolute;
    bottom: 0;
    left: 50%;
    width: 0;
    height: 2px;
    background-color: currentColor;
    transition:
      width 0.3s ease,
      left 0.3s ease;
  }

  /* Línea vertical derecha */
  .nav-link::before {
    content: "";
    position: absolute;
    right: -0.5rem;
    bottom: 0;
    width: 2px;
    height: 0;
    background-color: currentColor;
    transition: height 0.3s ease 0.1s;
    opacity: 0;
  }

  .nav-link:hover::after,
  .nav-link:active::after {
    width: 100%;
    left: 0;
  }

  .nav-link:hover::before,
  .nav-link:active::before {
    height: 100%;
    opacity: 1;
  }

  .nav-link:hover {
    color: #000;
  }

  .lang-toggle {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.25rem;
    border: 1px solid #000;
    border-radius: 0.75rem;
    background: #fff;
  }

  .lang-button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 2.5rem;
    height: 2.5rem;
    border: 1px solid transparent;
    border-radius: 9999px;
    background: #f5f5f5;
    transition:
      border-color 0.2s ease,
      box-shadow 0.2s ease,
      transform 0.1s ease;
  }

  .lang-button:is(:hover, :focus-visible) {
    border-color: #000;
    box-shadow: 0 0 0 2px #0000001a;
    outline: none;
    transform: translateY(-1px);
  }

  .lang-button.is-active {
    border-color: #000;
    background: #ffffff;
  }

  .lang-flag {
    width: 1.5rem;
    height: 1.5rem;
    object-fit: cover;
    border-radius: 50%;
    border: 1px solid #e5e5e5;
  }
</style>
