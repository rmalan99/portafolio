---
import { getRelativeLocaleUrl } from "astro:i18n";
import useLang from "../utils/useLang";
import { LANG_OPTIONS } from "../i18n/const/lang";
import ChevronDown from "../assets/chevromdown.svg";

const { lang } = useLang(Astro.url);
const { label, flag, name } = LANG_OPTIONS[lang];
const langOptions = Object.entries(LANG_OPTIONS).map(([key, value]) => ({
    name: key,
    label: value.label,
    flag: value.flag,
}));
---

<div class="lang-select" data-lang-select>
    <button
        class="lang-trigger"
        type="button"
        aria-haspopup="listbox"
        aria-expanded="false"
        aria-controls="lang-options"
        title={label}
        data-lang-trigger
    >
        <img src={flag} alt="" aria-hidden="true" class="lang-flag" />
        <span class="sr-only">{label}</span>
        <span class="lang-label uppercase">{name}</span>
        <span class="lang-caret" aria-hidden="true"
            ><ChevronDown aria-hidden="true" width={16} height={16} /></span
        >
    </button>

    <div
        class="lang-popover"
        role="listbox"
        id="lang-options"
        hidden
        data-lang-popover
    >
        {
            langOptions.map((option) => (
                <a
                    role="option"
                    class="lang-option"
                    href={getRelativeLocaleUrl(option.name, Astro.url)}
                    aria-selected={lang === option.name ? "true" : "false"}
                >
                    <img
                        src={option.flag}
                        alt=""
                        aria-hidden="true"
                        class="lang-flag"
                    />
                    <span>{option.label}</span>
                </a>
            ))
        }
    </div>
</div>

<script>
    const selectors = document.querySelectorAll("[data-lang-select]");

    selectors.forEach((root) => {
        const trigger = root.querySelector("[data-lang-trigger]");
        const popover = root.querySelector("[data-lang-popover]");

        if (
            !(trigger instanceof HTMLButtonElement) ||
            !(popover instanceof HTMLElement)
        ) {
            return;
        }

        const closePopover = () => {
            trigger.setAttribute("aria-expanded", "false");
            popover.hidden = true;
        };

        const openPopover = () => {
            trigger.setAttribute("aria-expanded", "true");
            popover.hidden = false;
        };

        trigger.addEventListener("click", (event) => {
            event.stopPropagation();
            if (popover.hidden) {
                openPopover();
            } else {
                closePopover();
            }
        });

        document.addEventListener("click", (event) => {
            if (!root.contains(event.target)) {
                closePopover();
            }
        });

        document.addEventListener("keydown", (event) => {
            if (event.key === "Escape") {
                closePopover();
                trigger.focus();
            }
        });
    });
</script>

<style>
    .lang-select {
        position: relative;
        display: inline-flex;
    }

    .lang-trigger {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
    }

    .lang-popover {
        position: absolute;
        right: 0;
        top: calc(100% + 0.5rem);
        display: grid;
        gap: 0.25rem;
        min-width: 9rem;
        padding: 0.5rem;
        border-radius: 0.75rem;
        background: #fff;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        z-index: 20;
        transform: translateY(-2px);
        transition: transform 0.1s ease;
    }

    .lang-popover[hidden] {
        transform: translateY(-2px);
    }

    .lang-option {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.35rem 0.5rem;
        border-radius: 0.5rem;
        color: #000;
        text-decoration: none;
        transition:
            background 0.2s ease,
            transform 0.1s ease;
    }

    .lang-option:is(:hover, :focus-visible) {
        background: #f5f5f5;
        outline: none;
        transform: translateY(-1px);
    }

    .lang-flag {
        width: 1.5rem;
        height: 1.5rem;
        object-fit: cover;
        border-radius: 50%;
        border: 1px solid #e5e5e5;
    }
</style>
